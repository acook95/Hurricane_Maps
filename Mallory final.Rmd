---
title: "HurricanMaps"
author: "Bruce Mallory"
date: "11/2/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load("maps","tmap","hurricaneexposuredata","tidyverse","drat", "magrittr", "sf", "dplyr")
```

### Read in all the data

```{r}
addRepo("geanders")
data("hurr_tracks")
data("rain")
county.longlat <- map_data("county")   
data(county.fips)

floyd_track <- hurr_tracks %>% filter(storm_id=="Floyd-1999") %>% filter(longitude <= -65) %>% filter(latitude >= 23)
floyd_rain <- rain %>% filter(storm_id=="Floyd-1999") 

allison_track <- hurr_tracks %>% filter(storm_id=="Allison-2001")
allison_rain <- rain %>% filter(storm_id=="Allison-2001")

mp_states <- c("texas", "oklahoma", "kansas",
               "iowa", "missouri", "arkansas", "louisiana",
               "alabama", "mississippi", "georgia", "florida",
               "tennessee","kentucky", "indiana", 
               "wisconsin", "michigan", "illinois",
               "ohio", "west virginia", "pennsylvania",
               "south carolina", "north carolina", 
               "virginia", "delaware", "maryland",
               "new jersey", "district of columbia", 
               "new york", "connecticut", "rhode island",
               "massachusetts", "vermont", "new hampshire",
               "maine")

states <- map_data('state', region = mp_states)

```

### Calculate total rain/fip, then make rain variable categorical (9 levels for FLoyd, 2 levels for Allison)

```{r}
floyd_rain %<>% group_by(fips) %>% summarise(rain = sum(precip), .groups="drop")
floyd_rain %<>% as.data.frame()
for (i in 1:dim(floyd_rain)[1]){
  floyd_rain$rain[i] <- floyd_rain$rain[i]%/%25
}
floyd_rain$rain <- ordered(floyd_rain$rain,labels = c("[0,25]","(25,50]","(50,75]",
                                               "(75,100]","(100,125]","(125,150]",
                                               "(150,175]","(175,200]","(200,220]"))

allison_rain %<>% group_by(fips) %>% summarise(rain = sum(precip), .groups="drop")
allison_rain %<>% as.data.frame()
for (i in 1:dim(allison_rain)[1]){
  if (allison_rain$rain[i] < 175){
    allison_rain$rain[i] <- 0
  }
  else {allison_rain$rain[i] <- 1}
}
allison_rain$rain <- ordered(allison_rain$rain, labels = c("Unexposed","Exposed"))
```

### Join files to get a single file with long, lat, rain (which will be used to plot the data)

```{r}
#first split "polyname" into "region" and "subregion" so: county.fips and county.longlat can be joined
county.fips %<>%
  separate(polyname, c("region", "subregion"), "," )
county <- left_join(county.longlat,county.fips, by = c("region", "subregion"))
#second make "fips" numeric so: "county" and "xxx_rain" can be joined
floyd_rain$fips <- as.numeric(floyd_rain$fips)
floyd_rain <- left_join(floyd_rain, county, by = "fips")
floyd_rain %<>% na.omit()
allison_rain$fips <- as.numeric(allison_rain$fips)
allison_rain <- left_join(allison_rain, county, by = "fips")
```

### Now plot the data (first the rain, then the states, then the track) and format the graph

```{r}
ggplot() +
  geom_polygon(data=floyd_rain, aes(x=long, y=lat, group=group, fill=rain), color="grey", size=0.05, alpha=.5) +
  scale_fill_brewer(name="Rainfall (mm)", palette="Blues") +
  geom_polygon(data=states, aes(x=long, y=lat, group=group), fill="transparent", color="black", size=0.1) +
  labs(title="Floyd-1999") +
  theme_minimal() +
  labs(x="", y="") +
  theme(plot.title = element_text(hjust = 0.5), element_line(size = 0), axis.text =element_blank()) +
  geom_path(data=floyd_track, aes(x=longitude, y=latitude), color="red", size=0.5)

ggplot() +
  geom_polygon(data=allison_rain, aes(x=long, y=lat, group=group, fill=rain), color="grey", size=0.05, alpha=.5) +
  scale_fill_brewer(name="Rain > 175mm", palette="Blues") +
  geom_polygon(data=states, aes(x=long, y=lat, group=group), fill="transparent", color="black", size=0.1) +
  ggtitle("Allison-2001")  +
  theme_minimal() +
  labs(x="", y="") +
  theme(plot.title = element_text(hjust = 0.5), element_line(size = 0), axis.text =element_blank()) +
  geom_path(data=allison_track, aes(x=longitude, y=latitude), color="red", size=0.5)

```
### AND try the same thing using tmap

```{r}
```{r}
## Transfer data into spatial version
tMap <- st_as_sf(map("county",StatesInt,plot=F,fill=T))

## Transfer RainFloyd into spatial format 
tRainFloyd1 <- RainFloyd %>% 
  select(region,subregion,rain_cut) %>% 
  mutate(ID=str_c(region,subregion,sep = ",")) %>% 
  select(ID,rain_cut) %>% 
  rename(`Rainfall(mm)`=rain_cut)

tRainFloyd <- left_join(tMap,tRainFloyd1,by="ID")

## Transfer TrackFloyd into spatial format
tTrackFloyd=cbind(TrackFloyd$longitude,TrackFloyd$latitude)%>%
  Line() %>% Lines(ID='Floyd-1999') %>%
  list() %>% SpatialLines()
```

#### 3.1.2 Making map
```{r}
tRainFloydPlot <- 
tm_shape(tRainFloyd)+
  tm_polygons(border.col="white",lwd=0.1,colorNA=NULL,
              col='Rainfall(mm)',style="cont",
              title="Rainfall(mm)",
              palette=cividis(n=7,direction=-1))+
  tm_shape(tTrackFloyd) +
  tm_lines(col='red')

# Add title
tRainFloydPlot + 
  tm_layout(main.title='Floyd-1999',
            main.title.position="center")
```



### 3.2 Allison-2001

#### 3.2.1 Data Organising
```{r}
## Transfer RainAllison into spatial format
tRainAllison1 <- RainAllison %>% 
  select(region,subregion,rain_cut) %>% 
  mutate(ID=str_c(region,subregion,sep = ",")) %>% 
  select(ID,rain_cut) %>% 
  rename(`Rainfall > 175mm`=rain_cut)

tRainAllison <- left_join(tMap,tRainAllison1,by="ID")

# Transfer TrackFloyd into spatial format
tTrackAllison=cbind(TrackAllison$longitude,TrackAllison$latitude) %>%
  Line() %>% Lines(ID='Floyd-1999') %>%
  list() %>% SpatialLines()
```

#### 3.2.2 Making map
```{r}
tRainAllisonPlot <- 
tm_shape(tRainAllison)+
  tm_polygons(border.col="white",lwd=0.1,colorNA=NULL,
              col='Rainfall > 175mm',style="cont",
              title="Rainfall > 175mm",
              palette=plasma(n=2,direction=-1))+
  tm_shape(tTrackAllison) +
  tm_lines(col='red')

# Add title
tRainAllisonPlot + 
  tm_layout(main.title='Allison-2001',
            main.title.position="center")
```


```